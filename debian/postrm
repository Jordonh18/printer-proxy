#!/bin/sh
# postrm script for continuum
#
# See: dh_installdeb(1)

set -e

APP_USER="continuum"
APP_GROUP="continuum"

case "$1" in
    purge)
        # Remove user and group
        if getent passwd "$APP_USER" > /dev/null 2>&1; then
            deluser --quiet --system "$APP_USER" 2>/dev/null || true
        fi
        if getent group "$APP_GROUP" > /dev/null 2>&1; then
            delgroup --quiet --system "$APP_GROUP" 2>/dev/null || true
        fi

        # Remove data directories
        rm -rf /var/lib/continuum
        rm -rf /var/log/continuum
        rm -rf /opt/continuum/venv

        # Remove configuration
        rm -rf /etc/continuum
        rm -f /etc/sudoers.d/continuum

        # Remove nginx configuration
        rm -f /etc/nginx/sites-enabled/continuum
        rm -f /etc/nginx/sites-available/continuum
        if systemctl is-active --quiet nginx 2>/dev/null; then
            systemctl reload nginx 2>/dev/null || true
        fi

        # Remove SSL certificates
        rm -f /etc/ssl/certs/continuum.crt
        rm -f /etc/ssl/private/continuum.key

        # Remove update service
        rm -f /etc/systemd/system/continuum-update.service
        systemctl daemon-reload 2>/dev/null || true
        ;;

    remove)
        # Stop and disable update service
        systemctl stop continuum-update.service 2>/dev/null || true
        rm -f /etc/systemd/system/continuum-update.service
        systemctl daemon-reload 2>/dev/null || true
        ;;

    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        ;;

    *)
        echo "postrm called with unknown argument '$1'" >&2
        exit 1
        ;;
esac

exit 0
