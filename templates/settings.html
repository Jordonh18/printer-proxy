{% extends "base.html" %}

{% block title %}Settings - Printer Proxy{% endblock %}

{% block extra_css %}
<style>
    /* Settings page layout */
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    /* Settings sidebar navigation */
    .settings-nav-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        position: sticky;
        top: 1rem;
    }
    
    .settings-nav {
        padding: 0.5rem;
    }
    
    .settings-nav .nav-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--foreground);
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.15s ease;
        border: none;
        text-decoration: none;
    }
    
    .settings-nav .nav-link:hover {
        background: var(--table-hover);
        color: var(--foreground);
    }
    
    .settings-nav .nav-link.active {
        background: var(--primary-bg);
        color: var(--foreground);
    }
    
    .settings-nav .nav-link i {
        font-size: 1rem;
        opacity: 0.7;
    }
    
    .settings-nav .nav-link.active i {
        opacity: 1;
    }
    
    /* Settings content card */
    .settings-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }
    
    .settings-card-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 1px solid var(--border);
        background: var(--background-secondary);
    }
    
    .settings-card-header h5 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--foreground);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .settings-card-header h5 i {
        color: var(--muted);
    }
    
    .settings-card-body {
        padding: 1.5rem;
    }
    
    .settings-description {
        color: var(--muted);
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }
    
    /* Notification channel blocks */
    .notification-channel {
        background: var(--background);
        border: 1px solid var(--border);
        border-radius: 0.625rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: border-color 0.15s ease;
    }
    
    .notification-channel:last-child {
        margin-bottom: 0;
    }
    
    .notification-channel:hover {
        border-color: var(--muted);
    }
    
    .notification-channel.disabled {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .channel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0;
    }
    
    .channel-header.has-content {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
    }
    
    .channel-title {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }
    
    .channel-title i {
        font-size: 1.125rem;
        color: var(--muted);
    }
    
    .channel-title .badge {
        font-size: 0.6875rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        background: var(--muted-bg);
        color: var(--muted);
    }
    
    /* Form controls */
    .form-label {
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--foreground);
        margin-bottom: 0.375rem;
    }
    
    .form-control {
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        color: var(--foreground);
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .form-control:focus {
        background: var(--input-bg);
        border-color: var(--info);
        box-shadow: 0 0 0 3px var(--info-bg);
        color: var(--foreground);
        outline: none;
    }
    
    .form-control::placeholder {
        color: var(--muted);
    }
    
    .form-text {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 0.25rem;
    }
    
    /* Toggle switch */
    .form-switch .form-check-input {
        width: 2.5rem;
        height: 1.25rem;
        background-color: var(--muted-bg);
        border: none;
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    
    .form-switch .form-check-input:checked {
        background-color: var(--success);
    }
    
    .form-switch .form-check-input:focus {
        box-shadow: 0 0 0 3px var(--info-bg);
    }
    
    .form-switch .form-check-label {
        font-size: 0.8125rem;
        color: var(--muted);
        margin-left: 0.25rem;
    }
    
    /* Radio buttons */
    .form-check-input[type="radio"] {
        background-color: var(--input-bg);
        border: 2px solid var(--border);
    }
    
    .form-check-input[type="radio"]:checked {
        background-color: var(--info);
        border-color: var(--info);
    }
    
    .form-check-label {
        font-size: 0.875rem;
        color: var(--foreground);
    }
    
    /* Input group */
    .input-group .btn-outline-secondary {
        border-color: var(--border);
        color: var(--muted);
        background: var(--background-secondary);
    }
    
    .input-group .btn-outline-secondary:hover {
        background: var(--table-hover);
        border-color: var(--border);
        color: var(--foreground);
    }
    
    /* Action buttons */
    .settings-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }
    
    .btn-primary {
        background: var(--primary);
        border-color: var(--primary);
        color: var(--primary-foreground);
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
    }
    
    .btn-primary:hover {
        opacity: 0.9;
        background: var(--primary);
        border-color: var(--primary);
    }
    
    .btn-outline-secondary {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--foreground);
        font-size: 0.875rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.15s ease;
    }
    
    .btn-outline-secondary:hover {
        background: var(--table-hover);
        border-color: var(--muted);
        color: var(--foreground);
    }
    
    /* Security options row */
    .security-options {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .security-options .form-check {
        margin: 0;
    }
    
    /* Page header */
    .page-header {
        margin-bottom: 1.5rem;
    }
    
    .page-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="page-header">
        <h1>Settings</h1>
    </div>

    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="settings-nav-card">
                <nav class="settings-nav nav flex-column" role="tablist">
                    <a class="nav-link active" id="notifications-tab" data-bs-toggle="pill" 
                       href="#notifications" role="tab" aria-controls="notifications" aria-selected="true">
                        <i class="bi bi-bell"></i>
                        Notifications
                    </a>
                    <a class="nav-link" id="updates-tab" data-bs-toggle="pill" 
                       href="#updates" role="tab" aria-controls="updates" aria-selected="false">
                        <i class="bi bi-cloud-download"></i>
                        Updates
                    </a>
                    <!-- Future settings sections -->
                    <!--
                    <a class="nav-link" id="general-tab" data-bs-toggle="pill" 
                       href="#general" role="tab" aria-controls="general" aria-selected="false">
                        <i class="bi bi-gear"></i>
                        General
                    </a>
                    <a class="nav-link" id="security-tab" data-bs-toggle="pill" 
                       href="#security" role="tab" aria-controls="security" aria-selected="false">
                        <i class="bi bi-shield-lock"></i>
                        Security
                    </a>
                    -->
                </nav>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="col-lg-9 col-md-8">
            <div class="tab-content">
                <!-- Notifications Settings -->
                <div class="tab-pane fade show active" id="notifications" role="tabpanel" aria-labelledby="notifications-tab">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h5><i class="bi bi-bell"></i> Notification Settings</h5>
                        </div>
                        <div class="settings-card-body">
                            <p class="settings-description">
                                Configure how Printer Proxy sends notifications for events like printer status changes, 
                                redirect activations, and system alerts.
                            </p>
                            
                            <!-- SMTP Email Settings -->
                            <div class="notification-channel">
                                <div class="channel-header has-content">
                                    <h6 class="channel-title">
                                        <i class="bi bi-envelope"></i>
                                        Email (SMTP)
                                    </h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" 
                                               id="smtpEnabled" 
                                               {% if settings.notifications.smtp.enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="smtpEnabled">Enabled</label>
                                    </div>
                                </div>
                                
                                <form id="smtpForm">
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label for="smtpHost" class="form-label">SMTP Server</label>
                                            <input type="text" class="form-control" id="smtpHost" 
                                                   placeholder="smtp.example.com"
                                                   value="{{ settings.notifications.smtp.host }}">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="smtpPort" class="form-label">Port</label>
                                            <input type="number" class="form-control" id="smtpPort" 
                                                   placeholder="587"
                                                   value="{{ settings.notifications.smtp.port or 587 }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="smtpUsername" class="form-label">Username</label>
                                            <input type="text" class="form-control" id="smtpUsername" 
                                                   placeholder="Optional"
                                                   value="{{ settings.notifications.smtp.username }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="smtpPassword" class="form-label">Password</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="smtpPassword" 
                                                       placeholder="{% if settings.notifications.smtp.password %}••••••••{% else %}Optional{% endif %}">
                                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">Leave blank to keep existing password</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="smtpFromAddress" class="form-label">From Address</label>
                                            <input type="email" class="form-control" id="smtpFromAddress" 
                                                   placeholder="noreply@example.com"
                                                   value="{{ settings.notifications.smtp.from_address }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="smtpToAddresses" class="form-label">To Addresses</label>
                                            <input type="text" class="form-control" id="smtpToAddresses" 
                                                   placeholder="admin@example.com, it@example.com"
                                                   value="{{ settings.notifications.smtp.to_addresses }}">
                                            <div class="form-text">Comma-separated list of recipients</div>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Security</label>
                                            <div class="security-options">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="smtpSecurity" 
                                                           id="smtpTLS" value="tls"
                                                           {% if settings.notifications.smtp.use_tls and not settings.notifications.smtp.use_ssl %}checked{% endif %}>
                                                    <label class="form-check-label" for="smtpTLS">
                                                        STARTTLS (Port 587)
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="smtpSecurity" 
                                                           id="smtpSSL" value="ssl"
                                                           {% if settings.notifications.smtp.use_ssl %}checked{% endif %}>
                                                    <label class="form-check-label" for="smtpSSL">
                                                        SSL/TLS (Port 465)
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="smtpSecurity" 
                                                           id="smtpNone" value="none"
                                                           {% if not settings.notifications.smtp.use_tls and not settings.notifications.smtp.use_ssl %}checked{% endif %}>
                                                    <label class="form-check-label" for="smtpNone">
                                                        None (Port 25)
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="settings-actions">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-lg me-1"></i>Save Settings
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="testSmtp">
                                            <i class="bi bi-send me-1"></i>Send Test Email
                                        </button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- Microsoft Teams (Coming Soon) -->
                            <div class="notification-channel disabled">
                                <div class="channel-header">
                                    <h6 class="channel-title">
                                        <i class="bi bi-microsoft-teams"></i>
                                        Microsoft Teams
                                        <span class="badge">Coming Soon</span>
                                    </h6>
                                </div>
                            </div>
                            
                            <!-- Slack (Coming Soon) -->
                            <div class="notification-channel disabled">
                                <div class="channel-header">
                                    <h6 class="channel-title">
                                        <i class="bi bi-slack"></i>
                                        Slack
                                        <span class="badge">Coming Soon</span>
                                    </h6>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Updates Settings -->
                <div class="tab-pane fade" id="updates" role="tabpanel" aria-labelledby="updates-tab">
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <h5><i class="bi bi-cloud-download"></i> Software Updates</h5>
                        </div>
                        <div class="settings-card-body">
                            <p class="settings-description">
                                Printer Proxy automatically checks for new releases from GitHub every 6 hours. 
                                Updates are never applied automatically - you must manually trigger installation.
                            </p>
                            <div class="alert alert-info" style="font-size: 0.8125rem;">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Note:</strong> During an update, the site will be temporarily unavailable for approximately 30-60 seconds while the service restarts. Please refresh the page after a minute.
                            </div>
                            
                            <!-- Current Version Info -->
                            <div class="mb-4">
                                <h6 class="mb-3" style="font-size: 0.875rem; font-weight: 600;">Current Version</h6>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="px-3 py-2" style="background: var(--muted-bg); border-radius: 0.5rem; font-family: 'Courier New', monospace; font-size: 0.875rem;">
                                        v{{ app_version }}
                                    </div>
                                    <span class="text-muted" style="font-size: 0.8125rem;" id="lastCheckText">
                                        Checking...
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Update Button (transforms based on state) -->
                            <div>
                                <button type="button" class="btn btn-outline-primary" id="updateActionBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Check for Updates Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Future: General Settings Tab -->
                <!-- Future: Security Settings Tab -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function() {
        const input = document.getElementById('smtpPassword');
        const icon = this.querySelector('i');
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
    });
    
    // Save SMTP settings
    document.getElementById('smtpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const security = document.querySelector('input[name="smtpSecurity"]:checked').value;
        const password = document.getElementById('smtpPassword').value;
        
        const data = {
            enabled: document.getElementById('smtpEnabled').checked,
            host: document.getElementById('smtpHost').value,
            port: parseInt(document.getElementById('smtpPort').value) || 587,
            username: document.getElementById('smtpUsername').value,
            from_address: document.getElementById('smtpFromAddress').value,
            to_addresses: document.getElementById('smtpToAddresses').value,
            use_tls: security === 'tls',
            use_ssl: security === 'ssl',
        };
        
        // Only include password if it was changed
        if (password) {
            data.password = password;
        }
        
        try {
            const response = await fetch('/api/settings/notifications/smtp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast('Settings saved successfully', 'success');
                // Clear password field after save
                document.getElementById('smtpPassword').value = '';
                document.getElementById('smtpPassword').placeholder = '••••••••';
            } else {
                showToast(result.error || 'Failed to save settings', 'danger');
            }
        } catch (error) {
            showToast('Error saving settings: ' + error.message, 'danger');
        }
    });
    
    // Toggle enabled state
    document.getElementById('smtpEnabled').addEventListener('change', async function() {
        try {
            const response = await fetch('/api/settings/notifications/smtp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ enabled: this.checked })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(this.checked ? 'SMTP notifications enabled' : 'SMTP notifications disabled', 'success');
            } else {
                showToast(result.error || 'Failed to update setting', 'danger');
                this.checked = !this.checked;
            }
        } catch (error) {
            showToast('Error updating setting: ' + error.message, 'danger');
            this.checked = !this.checked;
        }
    });
    
    // Test SMTP
    document.getElementById('testSmtp').addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
        
        try {
            const response = await fetch('/api/settings/notifications/smtp/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message || 'Test email sent successfully', 'success');
            } else {
                showToast(result.error || 'Failed to send test email', 'danger');
            }
        } catch (error) {
            showToast('Error sending test email: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
    
    // ========== Updates Section ==========
    
    let currentUpdateState = null;
    
    // Load initial update status
    loadUpdateStatus();
    
    async function loadUpdateStatus() {
        try {
            const response = await fetch('/api/update/status');
            const status = await response.json();
            currentUpdateState = status;
            
            // Update last check time
            if (status.last_check) {
                const lastCheck = new Date(status.last_check);
                const now = new Date();
                const diffMs = now - lastCheck;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                
                let timeText;
                if (diffMins < 1) {
                    timeText = 'Last checked just now';
                } else if (diffMins < 60) {
                    timeText = `Last checked ${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                } else if (diffHours < 24) {
                    timeText = `Last checked ${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                } else {
                    const diffDays = Math.floor(diffHours / 24);
                    timeText = `Last checked ${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
                }
                
                document.getElementById('lastCheckText').textContent = timeText;
            } else {
                document.getElementById('lastCheckText').textContent = 'Never checked';
            }
            
            // Update button based on state
            updateActionButton();
            
        } catch (error) {
            console.error('Error loading update status:', error);
            document.getElementById('lastCheckText').textContent = 'Error checking status';
        }
    }
    
    function updateActionButton() {
        const btn = document.getElementById('updateActionBtn');
        if (!btn || !currentUpdateState) return;
        
        if (currentUpdateState.update_available) {
            // Show install button
            btn.className = 'btn btn-primary';
            btn.innerHTML = '<i class="bi bi-download"></i> Install Update v' + currentUpdateState.available_version;
            btn.onclick = installUpdate;
        } else {
            // Show check button
            btn.className = 'btn btn-outline-primary';
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Check for Updates Now';
            btn.onclick = checkForUpdates;
        }
    }
    
    async function checkForUpdates() {
        const btn = document.getElementById('updateActionBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Checking...';
        
        try {
            const response = await fetch('/api/update/check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentUpdateState = result;
                
                if (result.update_available) {
                    showToast(`Update available: v${result.available_version}`, 'info');
                } else {
                    showToast('You are running the latest version', 'success');
                }
                
                // Update UI
                loadUpdateStatus();
            } else {
                showToast(result.error || 'Failed to check for updates', 'danger');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            showToast('Error checking for updates: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function installUpdate() {
        if (!confirm('This will download and install the update, then restart the service. Continue?')) {
            return;
        }
        
        const btn = document.getElementById('updateActionBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
        
        // Fire the request and redirect immediately
        fetch('/api/update/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(result => {
            if (!result.success) {
                showToast(result.message || 'Failed to start update', 'danger');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i> Install Update v' + currentUpdateState.available_version;
            }
        })
        .catch(error => {
            showToast('Error starting update: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download"></i> Install Update v' + currentUpdateState.available_version;
        });
        
        // Show message that update is in progress
        showToast('Update started. The site will be temporarily unavailable. Please refresh the page in about a minute.', 'info');
        
        // Disable the button permanently during update
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Update in progress...';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    }
});
</script>
{% endblock %}
