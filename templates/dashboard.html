{% extends "base.html" %}

{% block title %}Dashboard - Printer Proxy{% endblock %}

{% block extra_css %}
<style>
    .printer-card {
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        background: var(--card-bg);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
        display: block;
        transition: border-color 0.15s, box-shadow 0.15s;
    }
    .printer-card:hover {
        color: inherit;
        text-decoration: none;
        border-color: var(--muted);
    }
    .printer-card .card-header {
        border-bottom: 1px solid var(--border);
        padding: 1rem 1.25rem;
    }
    .printer-card .card-header.status-header-online {
        background: var(--success-bg);
        border-bottom-color: var(--success);
    }
    .printer-card .card-header.status-header-offline {
        background: var(--danger-bg);
        border-bottom-color: var(--danger);
    }
    .printer-card .card-header.status-header-redirected {
        background: var(--warning-bg);
        border-bottom-color: var(--warning);
    }
    .printer-card .card-header.status-header-target {
        background: var(--info-bg);
        border-bottom-color: var(--info-text);
    }
    .printer-card .card-body {
        padding: 1rem 1.25rem;
        background: var(--card-bg);
    }
    .printer-card .card-footer {
        background: var(--background-secondary);
        border-top: 1px solid var(--border);
        padding: 0.6rem 1.25rem;
        font-size: 0.75rem;
    }
    .printer-card .printer-name {
        font-weight: 600;
        font-size: 1rem;
        color: var(--foreground);
    }
    .printer-card .status-badge {
        font-size: 0.65rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .status-online { background: var(--success-bg); color: var(--success-text); }
    .status-offline { background: var(--danger-bg); color: var(--danger-text); }
    .status-redirected { background: var(--warning-bg); color: var(--warning-text); }
    .status-target { background: var(--info-bg); color: var(--info-text); }
    
    .printer-card .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.35rem 0;
        border-bottom: 1px solid var(--border);
        font-size: 0.8125rem;
    }
    .printer-card .info-row:last-child { border-bottom: none; }
    .printer-card .info-label { color: var(--muted); }
    .printer-card .info-value { 
        color: var(--foreground); 
        font-weight: 500;
        text-align: right;
        max-width: 60%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .printer-card .info-value code {
        background: var(--background-secondary);
        color: var(--foreground);
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    .printer-card .btn {
        border-radius: 0.5rem;
        font-size: 0.8125rem;
        font-weight: 500;
        padding: 0.4rem 0.75rem;
    }
    
    .redirect-indicator {
        background: var(--warning-bg);
        border: 1px solid var(--warning);
        border-radius: 0.5rem;
        padding: 0.6rem 0.75rem;
        margin-bottom: 0.75rem;
        font-size: 0.8125rem;
        color: var(--warning-text);
    }
    .redirect-indicator code {
        background: rgba(0,0,0,0.1);
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
    }
    
    /* Button styles */
    .btn-modern {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.15s;
        text-decoration: none;
    }
    .btn-outline-modern {
        background: var(--card-bg);
        color: var(--foreground);
        border: 1px solid var(--border);
    }
    .btn-outline-modern:hover {
        background: var(--table-hover);
        border-color: var(--muted);
        color: var(--foreground);
        text-decoration: none;
    }
    
    /* Active redirects table */
    .redirects-card {
        background: var(--card-bg);
        border: 1px solid var(--warning);
        border-radius: 0.75rem;
        overflow: hidden;
    }
    .redirects-card .card-header {
        background: var(--warning-bg);
        color: var(--warning-text);
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        border-bottom: 1px solid var(--warning);
    }
    .redirects-card .card-body {
        padding: 0;
    }
    .redirects-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    .redirects-table th {
        padding: 0.5rem 0.75rem;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
        background: var(--background-secondary);
        border-bottom: 1px solid var(--border);
    }
    .redirects-table td {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
        color: var(--foreground);
        border-bottom: 1px solid var(--border);
    }
    .redirects-table tr:last-child td {
        border-bottom: none;
    }
    .redirects-table code {
        background: var(--background-secondary);
        color: var(--foreground);
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    
    /* Empty state */
    .empty-state {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        padding: 3rem 2rem;
        text-align: center;
    }
    .empty-state h5 {
        color: var(--foreground);
    }
    .empty-state p {
        color: var(--muted);
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Printer Dashboard</h2>
    <div class="d-flex gap-2 align-items-center">
        <span class="text-muted" style="font-size: 0.75rem;" id="last-update"></span>
        <button class="btn-modern btn-outline-modern" onclick="refreshDashboard()" id="refresh-btn">
            <i class="bi bi-arrow-clockwise" id="refresh-icon"></i> Refresh
        </button>
    </div>
</div>

{% if active_redirects %}
<div class="redirects-card mb-4">
    <div class="card-header">
        <i class="bi bi-arrow-left-right"></i> Active Redirects
    </div>
    <div class="card-body">
        <table class="redirects-table">
            <thead>
                <tr>
                    <th>Source Printer</th>
                    <th>Source IP</th>
                    <th></th>
                    <th>Target Printer</th>
                    <th>Target IP</th>
                    <th>Enabled</th>
                    <th>By</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for redirect in active_redirects %}
                <tr>
                    <td>{{ redirect.source_printer_id }}</td>
                    <td><code>{{ redirect.source_ip }}</code></td>
                    <td style="color: var(--warning); font-weight: 600;">→</td>
                    <td>{{ redirect.target_printer_id }}</td>
                    <td><code>{{ redirect.target_ip }}</code></td>
                    <td>{{ redirect.enabled_at }}</td>
                    <td>{{ redirect.enabled_by }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('main.remove_redirect', printer_id=redirect.source_printer_id) }}" 
                              class="d-inline" onsubmit="return confirm('Remove this redirect?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                Remove
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="row">
    {% for item in printers %}
    {% set printer = item.printer %}
    {% set status = item.status %}
    <div class="col-md-6 col-lg-4 mb-4">
        <a href="{{ url_for('main.printer_detail', printer_id=printer.id) }}" class="card printer-card h-100" data-printer-id="{{ printer.id }}">
            <div class="card-header d-flex justify-content-between align-items-center {% if status.is_redirected %}status-header-redirected{% elif status.is_redirect_target %}status-header-target{% elif status.is_online %}status-header-online{% else %}status-header-offline{% endif %}">
                <span class="printer-name">{{ printer.name }}</span>
                {% if status.is_redirected %}
                    <span class="status-badge status-redirected">Redirected</span>
                {% elif status.is_redirect_target %}
                    <span class="status-badge status-target">Target</span>
                {% elif status.is_online %}
                    <span class="status-badge status-online">Online</span>
                {% else %}
                    <span class="status-badge status-offline">Offline</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">IP Address</span>
                    <span class="info-value"><code>{{ printer.ip }}</code></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Location</span>
                    <span class="info-value" title="{{ printer.location or '' }}">{{ printer.location or '—' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Model</span>
                    <span class="info-value" title="{{ printer.model or '' }}">{{ printer.model or '—' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Department</span>
                    <span class="info-value">{{ printer.department or '—' }}</span>
                </div>
                
                {% if status.is_redirected %}
                <div class="redirect-indicator mt-3">
                    <strong>Redirecting to:</strong> {{ status.redirect_info.target_printer_id }}
                    <br><code>{{ status.redirect_info.target_ip }}</code>
                </div>
                {% endif %}
                
                {% if status.is_redirected %}
                <div class="d-flex gap-2 mt-3">
                    <form method="POST" action="{{ url_for('main.remove_redirect', printer_id=printer.id) }}"
                          class="flex-grow-1" onsubmit="event.stopPropagation(); return confirm('Remove redirect?');" onclick="event.stopPropagation();">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger w-100">
                            Remove Redirect
                        </button>
                    </form>
                </div>
                {% elif not status.is_online and not status.is_redirect_target %}
                <div class="d-flex gap-2 mt-3">
                    <span class="btn btn-danger flex-grow-1">
                        Redirect
                    </span>
                </div>
                {% endif %}
            </div>
        </a>
    </div>
    {% endfor %}
</div>

{% if not printers %}
<div class="card">
    <div class="card-body text-center py-5">
        <h5 class="mt-3">No Printers Configured</h5>
        <p class="text-muted mb-3">Get started by discovering printers on your network or adding them manually.</p>
        <div class="btn-group">
            <a href="{{ url_for('main.discover_printers') }}" class="btn btn-outline-primary">
                Discover Printers
            </a>
            <a href="{{ url_for('main.add_printer') }}" class="btn btn-success">
                Add Printer
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let lastUpdate = new Date();
const updateTimeEl = document.getElementById('last-update');

function updateLastTime() {
    const now = new Date();
    const diff = Math.round((now - lastUpdate) / 1000);
    if (diff < 60) {
        updateTimeEl.textContent = diff === 0 ? 'Just now' : `${diff}s ago`;
    } else {
        updateTimeEl.textContent = `${Math.round(diff / 60)}m ago`;
    }
}

function refreshDashboard() {
    const btn = document.getElementById('refresh-btn');
    const icon = document.getElementById('refresh-icon');
    
    btn.disabled = true;
    icon.classList.add('spin');
    
    // Use the fast cached endpoint
    fetch('/api/dashboard/status')
        .then(response => response.json())
        .then(data => {
            // Update printer cards with new status
            data.forEach(item => {
                const card = document.querySelector(`[data-printer-id="${item.printer.id}"]`);
                if (card) {
                    updatePrinterCard(card, item);
                }
            });
            lastUpdate = new Date();
            updateLastTime();
        })
        .catch(err => {
            console.error('Error refreshing:', err);
        })
        .finally(() => {
            btn.disabled = false;
            icon.classList.remove('spin');
        });
}

function updatePrinterCard(card, item) {
    const status = item.status;
    const header = card.querySelector('.card-header');
    const badge = card.querySelector('.status-badge');
    
    // Update header class
    header.classList.remove('status-header-online', 'status-header-offline', 'status-header-redirected', 'status-header-target');
    badge.classList.remove('status-online', 'status-offline', 'status-redirected', 'status-target');
    
    if (status.is_redirected) {
        header.classList.add('status-header-redirected');
        badge.classList.add('status-redirected');
        badge.textContent = 'Redirected';
    } else if (status.is_redirect_target) {
        header.classList.add('status-header-target');
        badge.classList.add('status-target');
        badge.textContent = 'Target';
    } else if (status.is_online) {
        header.classList.add('status-header-online');
        badge.classList.add('status-online');
        badge.textContent = 'Online';
    } else {
        header.classList.add('status-header-offline');
        badge.classList.add('status-offline');
        badge.textContent = 'Offline';
    }
}

// Update the "ago" time every 10 seconds
setInterval(updateLastTime, 10000);
updateLastTime();

// Add spinning animation
const style = document.createElement('style');
style.textContent = `
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
`;
document.head.appendChild(style);

// Auto-refresh every 60 seconds (increased from 30 for less load)
setInterval(refreshDashboard, 60000);
</script>
{% endblock %}
