{% extends "base.html" %}

{% block title %}Discover Printers - Printer Proxy{% endblock %}

{% block extra_css %}
<style>
    /* Page header */
    .page-header {
        margin-bottom: 1.5rem;
    }
    .page-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--foreground);
        margin: 0;
    }
    
    /* Buttons */
    .btn-modern {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.15s;
        text-decoration: none;
    }
    .btn-primary-modern {
        background: var(--primary);
        color: var(--primary-foreground);
        border: none;
    }
    .btn-primary-modern:hover {
        opacity: 0.9;
        color: var(--primary-foreground);
        text-decoration: none;
    }
    .btn-primary-modern:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .btn-outline-modern {
        background: var(--card-bg);
        color: var(--foreground);
        border: 1px solid var(--border);
    }
    .btn-outline-modern:hover {
        background: var(--table-hover);
        border-color: var(--muted);
        color: var(--foreground);
        text-decoration: none;
    }
    .btn-success-modern {
        background: var(--success);
        color: white;
        border: none;
        padding: 0.35rem 0.75rem;
        font-size: 0.8rem;
    }
    .btn-success-modern:hover {
        opacity: 0.9;
        color: white;
    }
    .btn-success-modern:disabled {
        opacity: 0.6;
    }
    
    /* Cards */
    .detail-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }
    .detail-card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        font-size: 1rem;
        color: var(--foreground);
        background: var(--background-secondary);
    }
    .detail-card-body {
        padding: 1.25rem;
    }
    
    /* Form styling */
    .form-label-modern {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--foreground);
        margin-bottom: 0.4rem;
    }
    .form-input {
        display: block;
        width: 100%;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        color: var(--foreground);
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-input::placeholder {
        color: var(--muted);
    }
    .form-input-sm {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
    }
    
    .or-divider {
        color: var(--muted);
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    /* Discovery spinner */
    .discovery-spinner { display: none; }
    .discovering .discovery-spinner { display: inline-block; }
    .discovering .discovery-text { display: none; }
    
    /* Table toolbar */
    .table-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .table-count {
        font-size: 0.8rem;
        color: var(--muted);
    }
    
    /* Table styling */
    .modern-table {
        table-layout: fixed;
        width: 100%;
        border-collapse: collapse;
    }
    .modern-table thead {
        background: var(--background-secondary);
    }
    .modern-table th {
        padding: 0.4rem 1rem;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
    }
    .modern-table td {
        padding: 0.4rem 1rem;
        font-size: 0.875rem;
        color: var(--foreground);
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }
    .modern-table tbody tr:hover {
        background: var(--table-hover);
    }
    .modern-table tbody tr:last-child td {
        border-bottom: none;
    }
    .modern-table tbody tr.row-success {
        background: var(--success-bg);
    }
    
    .modern-table .col-ip { width: 110px; }
    .modern-table .col-name { width: 22%; }
    .modern-table .col-model { width: 20%; }
    .modern-table .col-location { width: 15%; }
    .modern-table .col-method { width: 70px; text-align: center; }
    .modern-table .col-caps { width: 90px; text-align: center; }
    .modern-table .col-action { width: 85px; text-align: right; }
    
    .modern-table code {
        background: var(--background-secondary);
        padding: 0.15rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
        color: var(--foreground);
    }
    
    /* Method pills */
    .method-pill {
        padding: 0.15rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .method-mdns {
        background: var(--info-bg);
        color: var(--info-text);
    }
    .method-snmp {
        background: var(--success-bg);
        color: var(--success-text);
    }
    .method-tcp {
        background: var(--muted-bg);
        color: var(--muted);
    }
    
    /* Caps badges */
    .caps-pill {
        padding: 0.1rem 0.4rem;
        border-radius: 0.25rem;
        font-size: 0.6rem;
        font-weight: 600;
        margin-left: 2px;
    }
    .caps-9100 {
        background: var(--primary-bg);
        color: var(--primary);
    }
    .caps-snmp {
        background: var(--success-bg);
        color: var(--success-text);
    }
    
    /* Empty state */
    .empty-state {
        padding: 3rem 2rem;
        text-align: center;
    }
    .empty-state-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--foreground);
        margin-bottom: 0.5rem;
    }
    .empty-state-text {
        color: var(--muted);
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">Discover Printers</h1>
    <a href="{{ url_for('main.manage_printers') }}" class="btn-modern btn-outline-modern">
        Back to Manage
    </a>
</div>

<div class="detail-card mb-4">
    <div class="detail-card-header">
        Network Scan
    </div>
    <div class="detail-card-body">
        <form method="POST" id="discoveryForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="row g-3 align-items-end">
                <div class="col-lg-5 col-md-12">
                    <label for="network" class="form-label-modern">Network to scan (CIDR)</label>
                    <input type="text" class="form-input" id="network" name="network" 
                           value="{{ network or '' }}"
                           placeholder="e.g., 10.0.0.0/24">
                </div>
                <div class="col-lg-1 col-md-12 text-center py-2 d-none d-lg-block">
                    <span class="or-divider">OR</span>
                </div>
                <div class="col-lg-4 col-md-12">
                    <label for="single_ip" class="form-label-modern">Scan single IP</label>
                    <input type="text" class="form-input" id="single_ip" name="single_ip" 
                           placeholder="e.g., 10.0.0.23">
                </div>
                <div class="col-lg-2 col-md-12">
                    <button type="submit" class="btn-modern btn-primary-modern w-100" id="scanBtn">
                        <span class="discovery-text">Scan</span>
                        <span class="discovery-spinner">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                            Scanning...
                        </span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if discovered is not none %}
<div class="table-toolbar">
    <span class="table-count">{{ discovered|length }} printer(s) found</span>
</div>

{% if discovered %}
<div class="detail-card mb-4">
    <div class="table-responsive">
        <table class="modern-table">
            <thead>
                <tr>
                    <th class="col-ip">IP Address</th>
                    <th class="col-name">Name</th>
                    <th class="col-model">Model</th>
                    <th class="col-location">Location</th>
                    <th class="col-method">Method</th>
                    <th class="col-caps">Caps</th>
                    <th class="col-action"></th>
                </tr>
            </thead>
            <tbody>
                {% for printer in discovered %}
                <tr data-ip="{{ printer.ip }}">
                    <td><code>{{ printer.ip }}</code></td>
                    <td>
                        <input type="text" class="form-input form-input-sm" 
                               id="name-{{ loop.index }}"
                               value="{{ printer.name or ('Printer at ' ~ printer.ip) }}">
                    </td>
                    <td>
                        <input type="text" class="form-input form-input-sm"
                               id="model-{{ loop.index }}"
                               value="{{ printer.model }}"
                               placeholder="—">
                    </td>
                    <td>
                        <input type="text" class="form-input form-input-sm"
                               id="location-{{ loop.index }}"
                               value="{{ printer.location }}"
                               placeholder="—">
                    </td>
                    <td class="text-center">
                        {% if printer.discovery_method == 'mDNS' %}
                            <span class="method-pill method-mdns">mDNS</span>
                        {% elif printer.discovery_method == 'SNMP' %}
                            <span class="method-pill method-snmp">SNMP</span>
                        {% else %}
                            <span class="method-pill method-tcp">TCP</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if printer.tcp_9100_open %}
                            <span class="caps-pill caps-9100" title="RAW/JetDirect port open">9100</span>
                        {% endif %}
                        {% if printer.snmp_available %}
                            <span class="caps-pill caps-snmp" title="SNMP available">SNMP</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        <form method="POST" action="{{ url_for('main.import_discovered_printer') }}" class="import-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="ip" value="{{ printer.ip }}">
                            <input type="hidden" name="name" class="name-field" value="{{ printer.name or ('Printer at ' ~ printer.ip) }}">
                            <input type="hidden" name="model" class="model-field" value="{{ printer.model }}">
                            <input type="hidden" name="location" class="location-field" value="{{ printer.location }}">
                            <button type="submit" class="btn-modern btn-success-modern import-btn">
                                Import
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="detail-card mb-4">
    <div class="empty-state">
        <div class="empty-state-title">No New Printers Found</div>
        <p class="empty-state-text">All printers already registered, or none responded on this network.</p>
    </div>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('discoveryForm').addEventListener('submit', function() {
    this.classList.add('discovering');
    document.getElementById('scanBtn').disabled = true;
});

document.querySelectorAll('.import-form').forEach(function(form, idx) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const row = form.closest('tr');
        const btn = form.querySelector('.import-btn');
        const nameInput = document.getElementById('name-' + (idx + 1));
        const modelInput = document.getElementById('model-' + (idx + 1));
        const locationInput = document.getElementById('location-' + (idx + 1));
        
        form.querySelector('.name-field').value = nameInput.value;
        form.querySelector('.model-field').value = modelInput.value;
        form.querySelector('.location-field').value = locationInput.value;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' },
            body: new FormData(form)
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (ok && data.success) {
                row.classList.add('row-success');
                btn.innerHTML = '✓ Done';
                btn.disabled = true;
                row.querySelectorAll('input:not([type=hidden])').forEach(inp => inp.disabled = true);
            } else {
                btn.disabled = false;
                btn.innerHTML = 'Import';
                alert(data.message || 'Import failed');
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = 'Import';
            alert('Error: ' + err.message);
        });
    });
});
</script>
{% endblock %}
