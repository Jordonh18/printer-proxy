name: PR Checks

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
      - '*.md'
      - '.gitignore'

permissions:
  contents: read

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Get version
        id: version
        run: |
          VERSION=$(python3 -c "exec(open('app/version.py').read()); print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: check-version
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev fakeroot gzip
      
      - name: Build .deb package
        run: |
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh
      
      - name: Verify package
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          DEB_FILE="builds/continuum_${VERSION}_all.deb"
          
          if [ ! -f "$DEB_FILE" ]; then
            echo "ERROR: Package not built"
            exit 1
          fi
          
          dpkg-deb --info "$DEB_FILE"
          cd builds && sha256sum -c "continuum_${VERSION}_all.deb.sha256"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: |
            builds/*.deb
            builds/*.sha256
          retention-days: 7

  test:
    name: Test Installation
    runs-on: ubuntu-latest
    needs: [check-version, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: builds/
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv python3-pip \
            iptables iproute2 iputils-ping arping nginx openssl
      
      - name: Test installation
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          sudo dpkg -i "builds/continuum_${VERSION}_all.deb" || sudo apt-get install -f -y
      
      - name: Verify installation
        run: |
          [ -d "/opt/continuum" ] && echo "OK: App directory exists"
          [ -d "/opt/continuum/venv" ] && echo "OK: Virtual environment created"
          [ -f "/lib/systemd/system/continuum.service" ] && echo "OK: Service installed"
          
          cd /opt/continuum
          sudo -u continuum /opt/continuum/venv/bin/python -c "from app import create_app; print('Imports OK')"
      
      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}';
            const version = '${{ needs.check-version.outputs.version }}';
            const icon = status === 'success' ? '✅' : '❌';
            
            const body = `## ${icon} Build & Test ${status === 'success' ? 'Passed' : 'Failed'}
            
            **Version:** \`${version}\`
            **Package:** \`continuum_${version}_all.deb\`
            
            ${status === 'success' ? 'All checks passed! Ready to merge.' : 'Some checks failed. Please review the logs.'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
