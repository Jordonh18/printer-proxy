name: Release

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/copilot-instructions.md'
      - 'LICENSE'
      - '*.md'
      - '.gitignore'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  check-changes:
    name: Check for Release-Worthy Changes
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      new_version: ${{ steps.version.outputs.new_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get current version
        id: current
        run: |
          VERSION=$(python3 -c "exec(open('app/version.py').read()); print(__version__)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Detect release-worthy changes
        id: changes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            BASE_REF=$(git rev-list --max-parents=0 HEAD)
          else
            BASE_REF="$LAST_TAG"
          fi

          echo "Base ref: $BASE_REF"
          CHANGED_FILES=$(git diff --name-only "$BASE_REF"..HEAD)

          # Ignore docs/markdown-only changes for release gating
          IGNORE_REGEX='^(README\.md|LICENSE|\.gitignore|docs/|\.github/|.*\.md$)'
          RELEASE_FILES=$(echo "$CHANGED_FILES" | grep -vE "$IGNORE_REGEX" || true)

          if [ -z "$RELEASE_FILES" ]; then
            echo "release_worthy=false" >> $GITHUB_OUTPUT
            echo "No release-worthy files changed."
          else
            echo "release_worthy=true" >> $GITHUB_OUTPUT
            echo "Release-worthy files changed:"
            echo "$RELEASE_FILES"
          fi

      - name: Decide release version
        id: check
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          RELEASE_WORTHY="${{ steps.changes.outputs.release_worthy }}"

          if [ "$RELEASE_WORTHY" != "true" ]; then
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "No release-worthy changes. Skipping release."
            exit 0
          fi

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${CURRENT_VERSION}")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Will create release v$CURRENT_VERSION"
            exit 0
          fi

          # Release exists, auto-bump patch or pre-release version
          NEW_VERSION=$(python3 - <<'PY'
import re
version = "${CURRENT_VERSION}"
base, sep, pre = version.partition('-')
parts = base.split('.')
while len(parts) < 3:
    parts.append('0')
major, minor, patch = [int(p) for p in parts[:3]]
if pre:
    m = re.match(r'(alpha|beta|rc)\.(\d+)$', pre)
    if m:
        label, num = m.group(1), int(m.group(2)) + 1
        new_version = f"{major}.{minor}.{patch}-{label}.{num}"
    else:
        patch += 1
        new_version = f"{major}.{minor}.{patch}-{pre}"
else:
    patch += 1
    new_version = f"{major}.{minor}.{patch}"
print(new_version)
PY
          )

          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Auto-bumping version: $CURRENT_VERSION -> $NEW_VERSION"
      
      - name: Set version output
        id: version
        run: echo "new_version=${{ steps.check.outputs.new_version }}" >> $GITHUB_OUTPUT

  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should_release == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev fakeroot gzip

      - name: Update version file if auto-bumped
        run: |
          VERSION="${{ needs.check-changes.outputs.new_version }}"
          CURRENT=$(python3 -c "exec(open('app/version.py').read()); print(__version__)")
          if [ "$VERSION" != "$CURRENT" ]; then
            cat > app/version.py << EOF
"""
Single source of truth for application version.

Update this file to change the version everywhere.
The build script and templates read from here.
"""

__version__ = "$VERSION"
__version_info__ = tuple(int(x) for x in __version__.split("."))

# For display
VERSION_STRING = f"Printer Proxy v{__version__}"
EOF
            echo "Updated app/version.py to $VERSION"
          fi
      
      - name: Build .deb package
        run: |
          chmod +x scripts/build-deb.sh
          ./scripts/build-deb.sh
      
      - name: Verify package
        run: |
          VERSION="${{ needs.check-changes.outputs.new_version }}"
          DEB_FILE="builds/printer-proxy_${VERSION}_all.deb"
          
          if [ ! -f "$DEB_FILE" ]; then
            echo "ERROR: Package not built"
            exit 1
          fi
          
          dpkg-deb --info "$DEB_FILE"
          cd builds && sha256sum -c "printer-proxy_${VERSION}_all.deb.sha256"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: |
            builds/*.deb
            builds/*.sha256
          retention-days: 7

  test:
    name: Test Installation
    runs-on: ubuntu-latest
    needs: [check-changes, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: builds/
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-venv python3-pip \
            iptables iproute2 iputils-ping arping nginx openssl
      
      - name: Test installation
        run: |
          VERSION="${{ needs.check-changes.outputs.new_version }}"
          sudo dpkg -i "builds/printer-proxy_${VERSION}_all.deb" || sudo apt-get install -f -y
      
      - name: Verify installation
        run: |
          [ -d "/opt/printer-proxy" ] && echo "OK: App directory exists"
          [ -d "/opt/printer-proxy/venv" ] && echo "OK: Virtual environment created"
          [ -f "/lib/systemd/system/printer-proxy.service" ] && echo "OK: Service installed"
          
          cd /opt/printer-proxy
          sudo -u printer-proxy /opt/printer-proxy/venv/bin/python -c "from app import create_app; print('Imports OK')"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [check-changes, build, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: builds/
      
      - name: Generate release notes
        run: |
          VERSION="${{ needs.check-changes.outputs.new_version }}"
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" --no-merges | head -20)
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          
          {
            echo "## What's Changed"
            echo ""
            echo "$COMMITS"
          } > release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-changes.outputs.new_version }}
          name: Printer Proxy v${{ needs.check-changes.outputs.new_version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.check-changes.outputs.new_version, 'beta') || contains(needs.check-changes.outputs.new_version, 'alpha') }}
          files: |
            builds/printer-proxy_${{ needs.check-changes.outputs.new_version }}_all.deb
            builds/printer-proxy_${{ needs.check-changes.outputs.new_version }}_all.deb.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-apt-repo:
    name: Deploy APT Repository
    runs-on: ubuntu-latest
    needs: [check-changes, release]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: builds/
      
      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
      
      - name: Build APT repository
        run: |
          VERSION="${{ needs.check-changes.outputs.new_version }}"
          DEB_FILE="builds/printer-proxy_${VERSION}_all.deb"
          
          # Create site directory
          mkdir -p site/pool/main
          mkdir -p site/dists/stable/main/binary-all
          
          # Copy static files from docs
          cp docs/index.html site/ 2>/dev/null || true
          cp docs/README.md site/ 2>/dev/null || true
          
          # Copy the package
          cp "$DEB_FILE" site/pool/main/
          
          # Generate Packages file
          cd site
          dpkg-scanpackages --arch all pool/ > dists/stable/main/binary-all/Packages
          gzip -9c dists/stable/main/binary-all/Packages > dists/stable/main/binary-all/Packages.gz
          
          # Generate Release file
          cd dists/stable
          {
            echo "Origin: Printer Proxy"
            echo "Label: Printer Proxy"
            echo "Suite: stable"
            echo "Codename: stable"
            echo "Architectures: all"
            echo "Components: main"
            echo "Description: Printer Proxy APT Repository"
            echo "Date: $(date -Ru)"
          } > Release
          
          {
            echo "MD5Sum:"
            for f in main/binary-all/Packages main/binary-all/Packages.gz; do
              if [ -f "$f" ]; then
                SIZE=$(stat -c %s "$f")
                HASH=$(md5sum "$f" | cut -d' ' -f1)
                echo " $HASH $SIZE $f"
              fi
            done
            echo "SHA256:"
            for f in main/binary-all/Packages main/binary-all/Packages.gz; do
              if [ -f "$f" ]; then
                SIZE=$(stat -c %s "$f")
                HASH=$(sha256sum "$f" | cut -d' ' -f1)
                echo " $HASH $SIZE $f"
              fi
            done
          } >> Release
      
      - name: Sign Release file
        run: |
          cd site/dists/stable
          gpg --batch --armor --detach-sign --output Release.gpg Release
          gpg --batch --armor --clearsign --output InRelease Release
      
      - name: Export public key
        run: |
          gpg --armor --export > site/gpg-key.asc
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
